name: Django CI/CD Pipeline

on:
  push:
    branches: [ "main" ]  # Run workflow on every push to the main branch
  workflow_dispatch:       # Allow manual trigger from GitHub Actions UI

jobs:
  build:
    name: Continuous Integration - Build & Test
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout the code from your GitHub repository
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Set up Python environment (Python 3.12)
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # 3Ô∏è‚É£ Install dependencies from requirements.txt
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 4Ô∏è‚É£ Run Django tests to verify the build
      - name: Run Tests
        run: |
          python manage.py test

  deploy:
    name: Continuous Deployment - PythonAnywhere
    needs: build
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Trigger a reload of your PythonAnywhere app securely
      - name: Deploy to PythonAnywhere
        env:
          PA_API_TOKEN: ${{ secrets.PA_API_TOKEN }}
        run: |
          echo "üöÄ Deploying to PythonAnywhere..."
          curl -X POST https://www.pythonanywhere.com/api/v0/user/pallaviagnihotri03/webapps/pallaviagnihotri03.pythonanywhere.com/reload/ \
          -H "Authorization: Token $aef88fafc956eb6ff028129ea3490537d04cb77d"
          echo "‚úÖ Deployment request sent to PythonAnywhere."
